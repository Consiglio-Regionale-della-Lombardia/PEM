@using PortaleRegione.Common
@using PortaleRegione.DTO.Enum
@model PortaleRegione.Client.Models.AttiViewModel

@{
    ViewBag.Title = string.Format("Riepilogo Atti Iscritti alla Seduta del {0:dd/MM/yyyy}.", Model.Seduta.Data_seduta);
}

<script>
    $(document).ready(function () {
        $('#btnSearch').hide();
    });

    function openDeleteModal(id) {
        $('#btnConfermaEliminazione').attr("href", '@Url.Action("EliminaAtto", "Atti", new { sedutaUId = Model.Seduta.UIDSeduta })?id=' + id);
        $('#modalDeleteAtto').modal('open');
    }

    $(document).ready(function () {
        $('#btnCreaAtto').attr('href', '@Url.Action("NuovoAtto", "Atti", new { sedutaUId = Model.Seduta.UIDSeduta })');
    });
</script>

<div class="row">
    <div class="col s12">
        <a class="btn-floating waves-effect waves-light grey darken-3 header-back"
           href="@Url.Action("RiepilogoSedute", "PEM")">
            <i class="material-icons">arrow_back</i>
        </a>
        <div class="row valign-wrapper">
            <div class="col s12">
                <h4>
                    <b>@ViewBag.Title</b>
                </h4>
            </div>
        </div>
    </div>
</div>

@{
    Html.RenderPartial("_PaginationBar", Model.Data.Paging);
}

<div id="attiTable" class="row">

    @if (!Model.Data.Results.Any())
    {
        <div class="row">
            <div class="col s12">
                <div class="card-panel panel-warning center">
                    <span class="center">
                        Non ci sono atti al momento
                    </span>
                </div>
            </div>
        </div>
    }

    @foreach (var atto in Model.Data.Results)
    {
        var titolo_atto = $"{Utility.GetText_Tipo(atto.IDTipoAtto)} {atto.NAtto}";

        var statoAtto = "";
        var coloreStatoAtto = "";
        if (atto.Chiuso)
        {
            statoAtto = "Chiuso";
            coloreStatoAtto = "grey-text";
        }
        else
        {
            if (!atto.Data_apertura.HasValue)
            {
                statoAtto = "Chiuso";
                coloreStatoAtto = "grey-text";
            }
            else if (atto.Data_apertura.Value < DateTime.Now)
            {
                statoAtto = "Aperto";
                coloreStatoAtto = "green-text";
            }
            else
            {
                var span = atto.Data_apertura.Value - DateTime.Now;
                var totalMinutes = Math.Round(span.TotalMinutes, MidpointRounding.AwayFromZero);

                if (totalMinutes <= 60)
                {
                    if (totalMinutes > 0 && totalMinutes <= 5)
                    {
                        statoAtto = "Mancano pochi minuti minuti all'apertura";
                    }
                    else
                    {
                        statoAtto = $"Mancano {totalMinutes} minuti all'apertura";
                    }
                }
                else
                {
                    statoAtto = $"Apertura prevista: {atto.Data_apertura.Value:dd/MM/yyyy HH:mm}";
                }

                coloreStatoAtto = "pink-text";
            }
        }

        if (!string.IsNullOrEmpty(statoAtto))
        {
            titolo_atto += $" ({statoAtto})";
        }

        <div class="col s12">
            <div class="card lighten-4 hoverable">
                <div class="card-action grey lighten-4">
                    <div class="row" style="margin: 0 !important; padding: 0 !important">
                        <div class="atti-checkbox-list">
                            @if (atto.IDTipoAtto == (int)TipoAttoEnum.PDL)
                            {
                                <div class="form-check">
                                    <label>
                                        <input type="checkbox"
                                               id="chkAbilitaFascicoloPresentazione_@atto.UIDAtto"
                                               onchange="PubblicaFascicolo('@atto.UIDAtto', @((int)OrdinamentoEnum.Presentazione))"
                                               @Html.Raw(atto.OrdinePresentazione.Value ? "checked=\"checked\"" : "")>
                                        <span>Abilita fascicolo presentazione</span>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <label>
                                        <input type="checkbox"
                                               id="chkAbilitaFascicoloVotazione_@atto.UIDAtto"
                                               onchange="PubblicaFascicolo('@atto.UIDAtto', @((int)OrdinamentoEnum.Votazione))"
                                               @Html.Raw(atto.OrdineVotazione.Value ? "checked=\"checked\"" : "")>
                                        <span>Abilita fascicolo votazione</span>
                                    </label>
                                </div>
                            }
                            <div class="form-check">
                                <label>
                                    <input type="checkbox"
                                           id="chkBloccoODG_@atto.UIDAtto"
                                           onchange="BloccaODG('@atto.UIDAtto', @(Convert.ToInt16(!atto.BloccoODG)))"
                                           @Html.Raw(atto.BloccoODG ? "checked=\"checked\"" : "")>
                                    <span>Blocco ODG</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <label>
                                    <input type="checkbox"
                                           id="chkJollyODG_@atto.UIDAtto"
                                           onchange="JollyODG('@atto.UIDAtto', @(Convert.ToInt16(!atto.Jolly)))"
                                           @Html.Raw(atto.Jolly ? "checked=\"checked\"" : "")>
                                    <span>Jolly</span>
                                </label>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="card-content">
                    <div class="row">
                        <div class="col s8">
                            <div class="row valign-wrapper" style="margin: 0 !important;">
                                <div class="col s12">
                                    <h5>
                                        <b>@titolo_atto</b>
                                        @if (atto.IDTipoAtto == (int)TipoAttoEnum.PDL)
                                        {
                                            if (atto.Fascicoli_Da_Aggiornare)
                                            {
                                                <i class="material-icons red-text right tooltipped" data-position="bottom"
                                                   data-tooltip="Sono intervenute modifiche successive alla data di generazione del fascicolo (es. aggiunta/ritiro di una firma). Il fascicolo non è attuale"
                                                   style="margin-top: 8px">warning</i>
                                            }
                                        }
                                        @if (!string.IsNullOrEmpty(atto.Path_Testo_Atto))
                                        {
                                            <button type="button" role="button"
                                                    class="btn-flat pink-text hide-on-large-only"
                                                    onclick="goIntoOtherTab('@Url.Action("Download", "Atti", new { path = atto.Path_Testo_Atto })')"
                                                    title="Scarica documento">
                                                SCARICA TESTO
                                            </button>
                                        }
                                    </h5>
                                </div>
                            </div>
                            <div class="row" style="margin: 0; margin-bottom: 0 !important">
                                <div class="col s12">
                                    <h6 class="active">
                                        <i>@Html.Raw(atto.Oggetto)</i>
                                    </h6>
                                </div>
                            </div>
                            <div class="row"
                                 style="margin-bottom: unset !important; margin-left: unset !important; margin-right: unset !important;">
                                <div class="col s12 left-align">
                                    @if (!string.IsNullOrEmpty(atto.Path_Testo_Atto))
                                    {
                                        <button type="button" role="button"
                                                class="btn-flat pink-text hide-on-med-and-down"
                                                onclick="goIntoOtherTab('@Url.Action("Download", "Atti", new { path = atto.Path_Testo_Atto })')"
                                                title="Scarica documento">
                                            SCARICA TESTO
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col s4 right-align">
                            <div class="atti-action-group">
                                @if (atto.CanMoveUp)
                                {
                                    <button type="button" role="button" class="btn-flat orange-text"
                                            onclick="go('@Url.Action("MoveUp", "Atti", new { id = atto.UIDAtto })')"
                                            title="Sposta su">
                                        <i class="material-icons left hide-on-small-only">arrow_upward</i>
                                        <i class="material-icons hide-on-med-and-up">arrow_upward</i>
                                        <span class="hide-on-small-only">SPOSTA SU</span>
                                    </button>
                                }
                                @if (atto.CanMoveDown)
                                {
                                    <button type="button" role="button" class="btn-flat orange-text"
                                            onclick="go('@Url.Action("MoveDown", "Atti", new { id = atto.UIDAtto })')"
                                            title="Sposta giù">
                                        <i class="material-icons left hide-on-small-only">arrow_downward</i>
                                        <i class="material-icons hide-on-med-and-up">arrow_downward</i>
                                        <span class="hide-on-small-only">SPOSTA GIU</span>
                                    </button>
                                }
                                <button type="button" role="button" class="btn-flat blue-text"
                                        onclick="go('@Url.Action("ModificaAtto", "Atti", new { id = atto.UIDAtto })')"
                                        title="Modifica">
                                    <i class="material-icons left hide-on-small-only">edit</i>
                                    <i class="material-icons hide-on-med-and-up">edit</i>
                                    <span class="hide-on-small-only">MODIFICA</span>
                                </button>
                                <button type="button" role="button" class="btn-flat red-text"
                                        onclick="openDeleteModal('@atto.UIDAtto')" title="Elimina">
                                    <i class="material-icons left hide-on-small-only">delete</i>
                                    <i class="material-icons hide-on-med-and-up">delete</i>
                                    <span class="hide-on-small-only">ELIMINA</span>
                                </button>
                                
                                @if (atto.IDTipoAtto == (int)TipoAttoEnum.PDL && atto.Data_apertura.HasValue)
                                {
                                    <button type="button" role="button" class="btn-flat black-text"
                                            onclick="go('@Url.Action("RiepilogoEmendamenti", "Emendamenti", new { id = atto.UIDAtto })')"
                                            title="Riepilogo emendamenti/subemendamenti"
                                            style="min-width:unset;">
                                        <i class="material-icons left hide-on-small-only">chevron_right</i>
                                        <i class="material-icons hide-on-med-and-up">chevron_right</i>
                                        <span class="hide-on-small-only">RIEPILOGO EM/SUBEM</span>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                    @if (atto.IDTipoAtto == (int)TipoAttoEnum.PDL)
                    {
                        <div class="row">
                            <div class="col s12 right-align">
                        
                                <div class="chip deep-purple lighten-4" style=" white-space: nowrap !important;">
                                    @atto.Conteggio_EM EM / @atto.Conteggio_SubEM SUBEM
                                </div>
                        
                            </div>
                        </div>
                    }
                </div>
                
            </div>
        </div>
    }
</div>

<div class="fixed-action-btn">
    <a id="btnCreaAtto" class="btn-floating btn-large blue darken-3">
        <i class="large material-icons">add</i>
    </a>
</div>

<div id="modalDeleteAtto" class="modal">
    <div class="modal-content">
        <h5>Attenzione</h5>
        <p>Sei sicuro di voler eliminare quest'atto?</p>
        <div class="modal-footer">
            <button type="button" class="btn modal-close grey">Annulla</button>
            <a id="btnConfermaEliminazione" class="btn red" href="#">Elimina</a>
        </div>
    </div>
</div>

@section scripts
{
    <script>
        setListaEmendamenti([]);
        setSelezionaTutti(false);
        set_Filtri_EM({});
    </script>
}