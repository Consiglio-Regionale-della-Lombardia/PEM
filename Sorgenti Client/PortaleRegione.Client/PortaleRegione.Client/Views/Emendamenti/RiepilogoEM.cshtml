@using System.Configuration
@using ExpressionBuilder.Common
@using PortaleRegione.DTO.Enum
@using PortaleRegione.DTO.Model
@model PortaleRegione.DTO.Response.EmendamentiViewModel

@section scripts
{
    <script>
        $(document).ready(async function () {
            $('#btnSearch').on("click", function () {
                openSearch();
            });
            $("#hdOrdine").val(@((int)Model.Ordinamento));
            var filters = @Html.Raw(Convert.ToInt16(Model.Data.Filters.Any()));
            if (filters == 0) {
                set_Filtri_EM({});
                set_ListaArticoliEM([]);
                set_ListaCommiEM([]);
                set_ListaLettereEM([]);
                $('#counterFilterActive').hide();
            } else {
                /*openSearch();*/
                $('#counterFilterActive').show();
            }

            Filtri_EM_CaricaText1("filter_em_text1");
            Filtri_EM_CaricaText2("filter_em_text2");
            Filtri_EM_CaricaTextConnector("filter_em_text_connector");
            Filtri_EM_CaricaNumeroEM("filter_em_n_em");
            Filtri_EM_CaricaMy("filter_em_my");
            Filtri_EM_CaricaFinancials("filter_em_effetti_finanziari");
            Filtri_EM_CaricaStatiEM("filter_em_stato");
            Filtri_EM_CaricaPartiEM("filter_em_parte");
            Filtri_EM_CaricaTipiEM("filter_em_tipo");

            checkSelectedEM();
        });

        function filtra() {
            setTimeout(function() {
                    $('body').removeClass('loaded');
                },
                200);
            $('#formFiltraEM').submit();
        }

        function filtra(page) {
            $('#inputFilterPage').val(page);
            setTimeout(function() {
                    $('body').removeClass('loaded');
                },
                200);
            $('#formFiltraEM').submit();
        }

        function filtra_Paginazione(size) {
            $('#inputFilterPage').val(1);
            $('#inputFilterSize').val(size);
            setTimeout(function() {
                    $('body').removeClass('loaded');
                },
                200);
            $('#formFiltraEM').submit();
        }

        function filtra_View(view) {
            $('#inputFilterView').val(view);
            setTimeout(function() {
                    $('body').removeClass('loaded');
                },
                200);
            $('#formFiltraEM').submit();
        }

        function filtra_Ordinamento(ordine) {
            $('#inputFilterPage').val(1);
            $('#inputFilterOrdine').val(ordine);
            setTimeout(function() {
                    $('body').removeClass('loaded');
                },
                200);
            $('#formFiltraEM').submit();
        }

        async function reset() {
            set_Filtri_EM({});
            $('#inputFilterPage').val(1);
            Filtri_EM_CaricaText1("filter_em_text1");
            Filtri_EM_CaricaText2("filter_em_text2");
            Filtri_EM_CaricaTextConnector("filter_em_text_connector");
            Filtri_EM_CaricaNumeroEM("filter_em_n_em");
            Filtri_EM_CaricaMy("filter_em_my");
            Filtri_EM_CaricaFinancials("filter_em_effetti_finanziari");
            Filtri_EM_CaricaStatiEM("filter_em_stato");
            Filtri_EM_CaricaTipiEM("filter_em_tipo");
            Filtri_EM_CaricaPartiEM("filter_em_parte");

            $('#filter_em_gruppi option').each(function(index, opt) {
                if ($(opt).is(":checked")) {
                    $(opt).attr("selected", false);
                }
            });
            $('#filter_em_proponente option').each(function(index, opt) {
                if ($(opt).is(":checked")) {
                    $(opt).attr("selected", false);
                }
            });
            $('#filter_em_firmatari option').each(function(index, opt) {
                if ($(opt).is(":checked")) {
                    $(opt).attr("selected", false);
                }
            });

            setTimeout(function() {
                    $('body').removeClass('loaded');
                },
                200);
            $('#formFiltraEM').submit();
        }

        function ShowHideTableColumn(ctrl, enable) {
            if (enable) {
                $('#th' + ctrl).show();
                $('td[id^="td' + ctrl + '"]').show();
            } else {
                $('#th' + ctrl).hide();
                $('td[id^="td' + ctrl + '"]').hide();
            }
        }

        $('#btnCreaEM').attr('href', '@Url.Action("NuovoEmendamento", new { id = Model.Atto.UIDAtto })');

        async function RevealMassivo(action) {
            var text = "";
            var button = "";

            var documentiTotali = $("#hdTotaleDocumenti").val();
            var selezionaTutti = getSelezionaTutti();
            var listaEM = getListaEmendamenti();
            var totaleDoc = selezionaTutti ? documentiTotali - listaEM.length : listaEM.length;

            if (totaleDoc <= 0) {
                ErrorAlert("Seleziona almeno un emendamento da elaborare");
                return;
            }

            if (action == @((int)ActionEnum.FIRMA)) {
                text = "Inserisci il PIN per firmare ";
                button = "Firma";
            } else if (action == @((int)ActionEnum.DEPOSITA)) {
                text = "Inserisci il PIN per depositare ";
                button = "Presenta";
            } else if (action == @((int)ActionEnum.INVITA)) {
                await NotificaA('@Model.Atto.UIDAtto', @((int)TipoDestinatarioNotificaEnum.CONSIGLIERI));
                return;
            }
            var limite_file = @Html.Raw(ConfigurationManager.AppSettings["LimiteDocumentiDaProcessare"]);
            if (totaleDoc > limite_file) {
                text = text + " (Verranno processati solamente i primi " + limite_file + " dell'atto)";
            } else {
                text = text + totaleDoc + " emendamenti";
            }
            swal(text,
                    {
                        content: {
                            element: "input",
                            attributes: { placeholder: "******", className: "password" }
                        },
                        buttons: { cancel: "Annulla", confirm: button }
                    })
                .then((value) => {
                    if (value == null || value == "")
                        return;

                    var obj = {};
                    obj.Pin = value;
                    obj.Azione = action;
                    obj.ListaEmendamenti = listaEM.length > 0 ? listaEM : [];
                    obj.AttoUId = '@Model.Atto.UIDAtto';
                    obj.Mode = @((int)Model.Mode);
                    obj.Richiesta_Firma = @Convert.ToInt16(Convert.ToBoolean(HttpUtility.ParseQueryString(Request.Url.Query).Get("require_my_sign")));

                    $.ajax({
                        url: baseUrl + "/emendamenti/azioni-massive",
                        type: "POST",
                        data: JSON.stringify(obj),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json"
                    }).done(function(data) {
                        swal({
                            title: "Esito procedura:",
                            text: data.message,
                            icon: "info",
                            button: "Ok"
                        }).then(() => {
                            DeselectALLEM();
                            location.reload();
                        });
                    }).fail(function(err) {
                        console.log("error", err);
                        ErrorAlert(err.message);
                    });
                });
        }

    </script>
}
<style>
    tr {
        border: unset;
    }

    td {
        text-align: center;
    }
</style>

@{
    ViewBag.Title = string.Format("{0} {1}", Model.Atto.TIPI_ATTO.Tipo_Atto, Model.Atto.NAtto);

    var filtri_attivi = Request.Url.AbsolutePath.Contains("filtra");

    var classActiveTabPresentazione = "";
    var classActiveTabVotazione = "";

    switch (Model.Ordinamento)
    {
        case OrdinamentoEnum.Presentazione:
        case OrdinamentoEnum.Default:
            classActiveTabPresentazione = "active";
            break;
        case OrdinamentoEnum.Votazione:
            classActiveTabVotazione = "active";
            break;
        default:
            throw new ArgumentOutOfRangeException();
    }
    var url = Url.Action("RiepilogoAtti", "Atti", new
    {
        id = Model.Atto.UIDSeduta
    });
    if (Model.Mode == ClientModeEnum.TRATTAZIONE)
    {
        url = Url.Action("Index", "AttiTrattazione", new { id = Model.Atto.UIDSeduta });
    }
}

<div class="row">
    <div class="col l1 s2">
        <a class="btn-floating waves-effect waves-light grey header-back" href="@url">
            <i class="material-icons">arrow_back</i>
        </a>
    </div>
    <div class="col l11 s10" style="display: inline-flex">
        <h5>
            <b>@ViewBag.Title</b>
        </h5>
        @if (!string.IsNullOrEmpty(Model.Atto.Path_Testo_Atto))
        {
            <a href="@Url.Action("Download", "Atti", new { path = Model.Atto.Path_Testo_Atto })" class="hoverable">
                <i class="material-icons pink-text medium tooltipped" data-tooltip="Scarica documento atto" style="padding-left: 20px">cloud_download</i>
            </a>
        }
        @if (Model.Mode == ClientModeEnum.TRATTAZIONE)
        {
            if (classActiveTabVotazione == "active")
            {
                <a target="_blank" href="@Url.Action("ViewerProietta", "Emendamenti", new { id = Model.Atto.UIDAtto })" class="btn chip hoverable purple white-text" style="margin-left: 20px; margin-top: 15px;">
                    <i class="icon material-icons">subscriptions</i> Proietta
                </a>
            }
        }
    </div>
</div>

<div id="emendamentiTable" class="row">
    @{
        if (Model.Mode == ClientModeEnum.TRATTAZIONE)
        {
            <ul id="RiepilogoEmendamentiTabs" class="tabs tabs-fixed-width">
                @if (!filtri_attivi)
                {
                    <li class="tab col s3">
                        <a class="@classActiveTabPresentazione" onclick="go('@Url.Action("RiepilogoEmendamenti", "Emendamenti", new { ordine = (int)OrdinamentoEnum.Presentazione, view = Model.ViewMode })')">Ordine Presentazione</a>
                    </li>
                    <li class="tab col s3">
                        <a class="@classActiveTabVotazione" onclick="go('@Url.Action("RiepilogoEmendamenti", "Emendamenti", new { ordine = (int)OrdinamentoEnum.Votazione, view = Model.ViewMode })')">Ordine Votazione</a>
                    </li>
                }
                else
                {
                    <li class="tab col s3">
                        <a class="@classActiveTabPresentazione" onclick="filtra_Ordinamento(@Html.Raw((int)OrdinamentoEnum.Presentazione))">Ordine Presentazione</a>
                    </li>
                    <li class="tab col s3">
                        <a class="@classActiveTabVotazione" onclick="filtra_Ordinamento(@Html.Raw((int)OrdinamentoEnum.Votazione))">Ordine Votazione</a>
                    </li>
                }
            </ul>
        }
        Html.RenderPartial("_PaginationBar", Model.Data.Paging);
        Html.RenderPartial("_Command_RiepilogoEM", new CommandRiepilogoModel { view = Model.ViewMode, mode = Model.Mode, IsAdmin = false, Atto = Model.Atto });

        <div class="row">
            @if (Model.ViewMode == ViewModeEnum.GRID)
            {
                Html.RenderPartial("_GridView_RiepilogoEM", Model);
            }
            else if (Model.ViewMode == ViewModeEnum.PREVIEW)
            {
                Html.RenderPartial("_ZoomView_RiepilogoEM", Model);
            }
        </div>
        Html.RenderPartial("_PaginationBar", Model.Data.Paging);
    }
</div>

@{
    Html.RenderPartial("_ComandiMassivi", Model.Atto.Chiuso);
    Html.RenderPartial("_PannelloStrumentiRicerche");
    Html.RenderPartial("_InvitoPanel", new InvitoPanelModel
    {
        UIDAtto = Model.Atto.UIDAtto
    });

    Html.RenderPartial("_StampaModal", Model.Atto.UIDAtto);
}
