<div id="modalFiltroConfig" class="modal">
    <div class="modal-content">
        <h4>Filtro</h4>
        <div id="chips-container-config">

        </div>

        <div class="row">
            <div class="input-field col s12">
                <input placeholder="Placeholder" id="filter_name" type="text" class="validate">
                <label for="first_name">Nome filtro</label>
            </div>
        </div>

        <div class="row">
            <div class="input-field col s12">
                <p>
                    <label>
                        <input id="filter_favourite" type="checkbox"/>
                        <span>Preferito</span>
                    </label>
                </p>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn-flat modal-close">Annulla</button>
        <button type="button" id="btnSalvaConfig" class="btn-flat blue-text">Salva</button>
    </div>
</div>

<script>
	var filtriPreferitiArray = [];
	if (document.getElementById('btnFiltroConfig')) {
        document.getElementById('btnFiltroConfig').addEventListener('click', function () {
            openModalWithContent_Preferiti("", localStorage.getItem('filtriDasi'));
        });
    }
    document.getElementById('btnSalvaConfig').addEventListener('click', async function () {
        var request = {};
        var filtri = JSON.parse(localStorage.getItem('filtriDasi'));
        request.filters = JSON.stringify(filtri);
        request.name = document.getElementById('filter_name').value;
        request.favourite = document.getElementById('filter_favourite').checked;

        // Invia la richiesta al server
        const response = await fetch('@Url.Action("SalvaGruppoFiltri")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(request),
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();
        if(data.message){
            ErrorAlert(data.message);
	        return;
        }

        await addChipIfNotExists_Preferiti(request.name, request.filters, request.favourite);
	    M.toast({
		    html: `<span><b class="yellow-text">${request.name}</b> aggiunto con successo</span>`, classes: 'rounded', displayLength: 5000 });

        $('#modalFiltroConfig').modal("close");
    });

	function openModalWithContent_Preferiti(name, filters) {
		$('#filter_favourite').prop("checked", false);
		$('#filter_name').val(name);
		$('#chips-container-config').empty();
		const filtri = JSON.parse(filters);
		if (filtri) {
			filtri.forEach(function (filtro) {
				addChipConfig(filtro.chipText);
			});
		}
		$('#modalFiltroConfig').modal("open");
	}

	function addChipConfig(chipText) {
		var chipsContainer = document.getElementById('chips-container-config');
		var newChip = document.createElement('div');
		newChip.classList.add('chip', 'yellow', 'black-text');
		newChip.textContent = chipText;

		chipsContainer.appendChild(newChip);
	}

	async function addChipIfNotExists_Preferiti(name, filters, favourite) {

		var existingChip = document.querySelector(`.chip[data-nome-gruppo-filtri="${name}"]`);

		if (existingChip) {
			return;
		}
		var item = {};
		item.name = name;
		item.favourite = favourite;
		item.filters = filters;
		filtriPreferitiArray.push(item);

		await creaPannelloFiltriLaterale2();

		if (!favourite) {
			return;
		}

		var chipsContainer = document.getElementById('chips-container-groups');
		var newChip = document.createElement('div');
		newChip.classList.add('chip', 'white', 'black-text');
		newChip.setAttribute('data-nome-gruppo-filtri', name);
		newChip.textContent = name;

		var starIcon = document.createElement('i');
		starIcon.classList.add('material-icons', 'tiny');
		starIcon.style.setProperty('margin-left', '10px');
		starIcon.style.setProperty('top', '2px');
		starIcon.textContent = 'star';
		newChip.appendChild(starIcon);

		newChip.onclick = function (event) {
			event.stopPropagation();
			resetSelezionePreferiti();
			newChip.classList.replace("white", "yellow");
			localStorage.setItem('filtriDasi', filters);
			chipsKeys = [];

			ripristinaFiltri();
		};

		chipsContainer.appendChild(newChip);

		toggleChipsGroupsRow();
	}

	async function creaPannelloFiltriLaterale2() {
		const collection = document.getElementById('data-collection');
		$('#data-collection').empty();

		// >>> SEZIONE PREFERITI (contenitore dedicato)
		const preferitiSection = document.createElement('div');
		preferitiSection.id = 'preferiti-section';
		collection.appendChild(preferitiSection);

		preferitiSection.appendChild(preferitiHeader());
		preferitiSection.appendChild(preferitiLoader());

		// >>> SEZIONE STANDARD (resta nella collection principale)
		collection.appendChild(standardHeader());
		availableFilterArray.forEach(function (item) {
			const li = document.createElement('a');
			li.className = 'collection-item';
			li.textContent = item.tag;
			li.onclick = async function (event) {
				event.stopPropagation();
				await openModalWithContent(item.id, item.tag, false, 0);
			};
			collection.appendChild(li);
		});

		try {
			const preferiti = await GetFiltriPreferitiDASI();
			window.filtriPreferitiArray = Array.isArray(preferiti) ? preferiti : [];
			// >>> RENDER DENTRO LA SEZIONE PREFERITI
			renderPreferiti(preferitiSection, window.filtriPreferitiArray);
		} catch (e) {
			console.warn('Errore/timeout preferiti:', e);
			const loader = preferitiSection.querySelector('#preferiti-loader');
			if (loader) loader.remove();
			const err = document.createElement('div');
			err.className = 'red-text';
			err.style.padding = '8px 16px';
			err.textContent = 'Impossibile caricare i tuoi gruppi adesso.';
			preferitiSection.appendChild(err);
		}
	}

	function renderPreferiti(preferitiSectionEl, list) {
		const loader = preferitiSectionEl.querySelector('#preferiti-loader');
		if (loader) loader.remove();

		if (!list || list.length === 0) {
			const empty = document.createElement('div');
			empty.className = 'grey-text';
			empty.style.padding = '8px 16px';
			empty.textContent = 'Nessun gruppo salvato.';
			preferitiSectionEl.appendChild(empty);
			return;
		}

		list.forEach(function (item) {
			const li = document.createElement('a');
			li.className = item.favourite ? 'collection-item badgeStarCollectionFilter' : 'collection-item badgeCollectionFilter';
			li.textContent = item.name;

			li.onclick = function (event) {
				event.stopPropagation();
				if (item.favourite) {
					$(`[data-nome-gruppo-filtri="${item.name}"]`).click();
				} else {
					resetSelezionePreferiti();
					localStorage.setItem('filtriDasi', item.filters);
					window.chipsKeys = [];
					ripristinaFiltri();
				}
			};

			const deleteIcon = document.createElement('i');
			deleteIcon.className = 'material-icons secondary-content';
			deleteIcon.style.marginRight = '10px';
			deleteIcon.textContent = 'delete';
			deleteIcon.classList.add('red-text');
			deleteIcon.onclick = async function (event) {
				event.stopPropagation();
				swal(`Sei sicuro di voler eliminare il gruppo di filtri "${item.name}"?`, {
					buttons: ["No", "Si"],
				}).then(async (value) => {
					if (value == true) {
						try {
							let deleteUrl = '@Url.Action("EliminaGruppoFiltri", "DASI")';
							deleteUrl = `${deleteUrl}?nomeFiltro=${encodeURIComponent(item.name)}`;
							const response = await fetch(deleteUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
							if (!response.ok) throw new Error('Network response was not ok');

							const data = await response.json();
							if (data.message) { ErrorAlert(data.message); return; }

							M.toast({ html: `<span><b class="yellow-text">${item.name}</b> eliminato con successo</span>`, classes: 'rounded', displayLength: 5000 });
							li.remove();
							$(`[data-nome-gruppo-filtri="${item.name}"]`).remove();
							toggleChipsGroupsRow();
						} catch (error) {
							console.error('Errore di fetch:', error);
							ErrorAlert(error.message);
						}
					}
				});
			};

			li.appendChild(deleteIcon);
			// <<< appendiamo alla SEZIONE PREFERITI, non alla collection globale
			preferitiSectionEl.appendChild(li);
		});
	}

	// --- headers/loader per la UI preferiti/standard ---
	function preferitiHeader() {
		const h = document.createElement('div');
		h.className = 'collection-header';
		h.style.padding = '8px 16px';
		h.innerHTML = '<strong>I miei gruppi</strong>';
		return h;
	}
	function standardHeader() {
		const h = document.createElement('div');
		h.className = 'collection-header';
		h.style.padding = '8px 16px';
		h.innerHTML = '<strong>Filtri standard</strong>';
		return h;
	}
	function preferitiLoader() {
		const div = document.createElement('div');
		div.id = 'preferiti-loader';
		div.innerHTML = `
    <div class="progress" style="margin:8px 16px;">
      <div class="indeterminate"></div>
    </div>`;
		return div;
	}

	// --- piccolo timeout per evitare spinner infiniti ---
	function withTimeout(promise, ms = 8000) {
		return Promise.race([
			promise,
			new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout caricamento preferiti')), ms))
		]);
	}



	function creaPannelloFiltriLaterale() {
        var collection = document.getElementById('data-collection');
        $('#data-collection').empty();
        filtriPreferitiArray.forEach(function (item) {
	        var li = document.createElement('a');
		    if (item.favourite){
			    li.className = 'collection-item badgeStarCollectionFilter';
		    }else {
			    li.className = 'collection-item badgeCollectionFilter';
		    }

	        li.textContent = item.name;
		    li.onclick = function (event) {
                event.stopPropagation();

			    if (item.favourite){
				    $(`[data-nome-gruppo-filtri="${item.name}"]`).click();
			    }else {
				    resetSelezionePreferiti();
				    localStorage.setItem('filtriDasi', item.filters);
				    chipsKeys = [];
				    
				    ripristinaFiltri();
			    }
            };

		    var deleteIcon = document.createElement('i');
		    deleteIcon.className = 'material-icons secondary-content';
		    deleteIcon.style.marginRight = '10px';
		    deleteIcon.textContent = 'delete';
		    deleteIcon.classList.add('red-text');
		    deleteIcon.onclick = async function (event) {
			    event.stopPropagation();
			    swal(`Sei sicuro di voler eliminare il gruppo di filtri "${item.name}"?`, {
				    buttons: ["No", "Si"],
			    }).then(async (value) => {
				    if (value == true){
					    try {
						    var deleteUrl = '@Url.Action("EliminaGruppoFiltri", "DASI")';
						    deleteUrl = `${deleteUrl}?nomeFiltro=${encodeURIComponent(item.name)}`;
						    let response = await fetch(deleteUrl, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }

                            let data = await response.json();
                            if(data.message){
                                ErrorAlert(data.message);
                                return;
                            }

						    M.toast({
							    html: `<span><b class="yellow-text">${item.name}</b> eliminato con successo</span>`, classes: 'rounded', displayLength: 5000 });

						    li.remove();
						    var indexToRemove = filtriPreferitiArray.findIndex(el => el.name === item.name);

						    if (indexToRemove !== -1) {
							    filtriPreferitiArray.splice(indexToRemove, 1);
						    }
						    $(`[data-nome-gruppo-filtri="${item.name}"]`).remove();
						    toggleChipsGroupsRow();
					    } catch (error) {
						    console.error('Errore di fetch:', error);
						    ErrorAlert(error.message);
					    }
				    }
			    });
		    };
		    li.appendChild(deleteIcon);
	        collection.appendChild(li);
        });

        availableFilterArray.forEach(function (item) {
	        var li = document.createElement('a');
	        li.className = 'collection-item';
	        li.textContent = item.tag;

	        li.onclick = async function (event) {
		        event.stopPropagation();
		        await openModalWithContent(item.id, item.tag, false, 0);
	        };
	        collection.appendChild(li);
        });
    }

	function resetSelezionePreferiti() {
		var chipsContainer = document.getElementById('chips-container-groups');
		var chips = chipsContainer.getElementsByClassName('chip');
		$.each(chips, function (index, chip) {
			chip.className = 'chip white black-text';
		});
	}
	
	async function ripristinaPreferiti() {
		$.each(window.filtriPreferitiArray, async function (index, item) {
			await addChipIfNotExists_Preferiti(item.name, item.filters, item.favourite)
		});
		toggleChipsGroupsRow();
	}

	function toggleChipsGroupsRow() {
		var chipsContainer = document.getElementById('chips-container-groups');
		if (!chipsContainer) return;
		var row = chipsContainer.closest('.row');
		// Se non trova una .row, prova col parent diretto:
		if (!row) row = chipsContainer.parentElement;
		// Conta solo i chip veri (non spazi/testo)
		var chips = chipsContainer.querySelectorAll('.chip');
		if (chips.length === 0) {
			row.style.display = "none";
		} else {
			row.style.display = "";
		}
	}
</script>