@using PortaleRegione.DTO.Enum
<script>
    var instanceModalDasi;

    $("#btnSave").on("click",
        function() {
            $('#formDASI').submit();
        });
    $("#formDASI").submit(function(e) {
        e.preventDefault();
    }).validate({
        submitHandler: function(form) {

            var proponente;
            if ($('input[name="Atto.UIDPersonaProponente"]').val())
                proponente = $('input[name="Atto.UIDPersonaProponente"]').val();
            else {
                //if ($('#chkProponentiConsiglieri').is(":checked"))
                //    proponente = $('select[id="selectProponentiConsiglieri"]').children("option:selected").val();
                //else if ($('#chkProponentiAssessori').is(":checked"))
                //    proponente = $('select[id="selectProponentiConsiglieri"]').children("option:selected").val();
                //else
                //    proponente = $('select[id="Emendamento_UIDPersonaProponente"]').children("option:selected").val();
            }

            var container_oggetto_originale = $("#Atto_Oggetto").parent();
            var editor_oggetto_originale = $(container_oggetto_originale).find(".trumbowyg-editor");
            var container_testo_originale = $("#Atto_Testo").parent();
            var editor_testo_originale = $(container_testo_originale).find(".trumbowyg-editor");

            var form_data = new FormData();
            form_data.append("IDTipo_Risposta", $('select[id="Atto_TipoRisposta"]').children("option:selected").val());
            form_data.append("Oggetto", editor_oggetto_originale.html());
            form_data.append("Testo", editor_testo_originale.html());
            form_data.append("Tipo", $("#Atto_Tipo").val());
            form_data.append("UIDAtto", $("#Atto_UIDAtto").val());

            var soggettiInterrogati = [];
            var soggettiInterrogabiliCheckboxes = $('input[id^="chk_"]:checked');
            soggettiInterrogabiliCheckboxes.each(function() {
                soggettiInterrogati.push($(this).val());
            });
            console.log(soggettiInterrogati);
            form_data.append("SoggettiInterrogati_client", soggettiInterrogati);

            $.ajax({
                url: '@Url.Action("SalvaAtto")',
                type: "POST",
                data: form_data,
                processData: false,
                contentType: false
            }).done(function(data) {
                console.log(data);

                swal({
                    title: "Procedura completata",
                    text: "Atto inserito correttamente a sistema.",
                    icon: "success"
                }).then((value) => {
                    go(data);
                });

            }).fail(function(err) {
                console.log("error", err);
                ErrorAlert(err.message);
            });
        }
    });

    function openFormDASI(tipo, edit) {
        var tipo_dasi = tipo;
        var title = GetTitle(tipo, edit);
        $('#hdTipoAttoDasi').val(tipo);
        $('#titleDasiModal').text(title);
        $('select').formSelect();
        var elemAutocomplete = document.querySelector('#autocompleteSoggettoDestinatarioDasi');

        var autocompleteDataOptions = {
            data: [
                { tag: 'I Commissione permanente - Economia e Bilancio', id: '1' },
                { tag: 'II Commissione', id: '2' },
                { tag: 'III Commissione', id: '3' }
            ],
            limit: 10,
            minLength: 1
        };
        M.Chips.init(elemAutocomplete,
            {
                autocompleteOptions: autocompleteDataOptions,
                onChipAdd: function(e, chip) {
                },
                onChipSelect: function(e, chip) {
                },
                onChipDelete: function(e, chip) {
                }
            });
        var elemModal = document.querySelector("#modalAggiungiDASI");
        var options = {
            dismissible: false
        };
        instanceModalDasi = M.Modal.init(elemModal, options);
        instanceModalDasi.open();
    }

    function GetTitle(tipo_dasi, edit) {
        var prefix = edit ? "Modifica" : "Nuovo";
        if (tipo_dasi == @Html.Raw((int) TipoAttoEnum.ITL)) {
            return prefix + " ITL";
        } else if (tipo_dasi == @Html.Raw((int) TipoAttoEnum.ITR)) {
            return prefix + " ITR";
        } else if (tipo_dasi == @Html.Raw((int) TipoAttoEnum.IQT)) {
            return prefix + " IQT";
        } else if (tipo_dasi == @Html.Raw((int) TipoAttoEnum.MOZ)) {
            return prefix + " MOZ";
        } else if (tipo_dasi == @Html.Raw((int) TipoAttoEnum.ODG)) {
            return prefix + " ODG";
        }
    }
</script>